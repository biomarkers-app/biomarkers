// geometry.ts tests
import exp from 'constants';
import { Point, BoundingBox, getDistance, getDistanceFromLine, getBoundingBoxSize, getBoundingBoxAlignments } from './geometry';

const rightAlignedBoxes: BoundingBox[] = [
	[
		[0.1111111119389534, 0.08561236411333084],
		[0.11616161465644836, 0.08561236411333084],
		[0.11447811126708984, 0.09750296920537949],
		[0.1111111119389534, 0.09750296920537949],
	],
	[
		[0.16161616146564484, 0.08561236411333084],
		[0.18686868250370026, 0.0868014246225357],
		[0.18686868250370026, 0.09869202971458435],
		[0.16161616146564484, 0.09869202971458435],
	],
	[
		[0.3080808222293854, 0.1034482792019844],
		[0.31144779920578003, 0.1034482792019844],
		[0.31144779920578003, 0.11296076327562332],
		[0.3080808222293854, 0.11296076327562332],
	],
	[
		[0.683501660823822, 0.28537455201148987],
		[0.7390572428703308, 0.28537455201148987],
		[0.7390572428703308, 0.29607608914375305],
		[0.683501660823822, 0.29607608914375305],
	],
	[
		[0.7154881954193115, 0.29964327812194824],
		[0.7356902360916138, 0.29964327812194824],
		[0.7373737096786499, 0.3115338981151581],
		[0.7154881954193115, 0.3115338981151581],
	],
	[
		[0.7053872346878052, 0.3139120042324066],
		[0.7356902360916138, 0.31272295117378235],
		[0.7356902360916138, 0.3246135413646698],
		[0.7070707082748413, 0.3246135413646698],
	],
	[
		[0.7154881954193115, 0.3269916772842407],
		[0.7356902360916138, 0.3269916772842407],
		[0.7356902360916138, 0.3376932144165039],
		[0.7154881954193115, 0.3376932144165039],
	],
	[
		[0.7222222089767456, 0.3412604033946991],
		[0.7356902360916138, 0.3412604033946991],
		[0.7356902360916138, 0.350772887468338],
		[0.7222222089767456, 0.350772887468338],
	],
	[
		[0.7239057421684265, 0.35552912950515747],
		[0.7373737096786499, 0.35552912950515747],
		[0.7373737096786499, 0.3650416135787964],
		[0.7239057421684265, 0.3650416135787964],
	],
	[
		[0.7205387353897095, 0.3709869086742401],
		[0.7373737096786499, 0.3709869086742401],
		[0.7373737096786499, 0.38287752866744995],
		[0.7205387353897095, 0.38287752866744995],
	],
	[
		[0.7138047218322754, 0.3840665817260742],
		[0.7356902360916138, 0.38287752866744995],
		[0.7373737096786499, 0.39595720171928406],
		[0.7154881954193115, 0.3971462547779083],
	],
	[
		[0.7222222089767456, 0.3971462547779083],
		[0.7356902360916138, 0.3971462547779083],
		[0.7356902360916138, 0.4078477919101715],
		[0.7222222089767456, 0.4078477919101715],
	],
	[
		[0.7239057421684265, 0.41260403394699097],
		[0.7356902360916138, 0.41260403394699097],
		[0.7356902360916138, 0.4221165180206299],
		[0.7239057421684265, 0.4221165180206299],
	],
	[
		[0.6936026811599731, 0.4256837069988251],
		[0.7390572428703308, 0.4256837069988251],
		[0.7390572428703308, 0.43638524413108826],
		[0.6936026811599731, 0.43638524413108826],
	],
	[
		[0.6936026811599731, 0.43995243310928345],
		[0.7390572428703308, 0.43995243310928345],
		[0.7390572428703308, 0.4518430531024933],
		[0.6936026811599731, 0.4518430531024933],
	],
	[
		[0.5858585834503174, 0.4554102122783661],
		[0.5976430773735046, 0.4554102122783661],
		[0.5976430773735046, 0.4673008322715759],
		[0.5841751098632812, 0.4673008322715759],
	],
	[
		[0.7239057421684265, 0.4542211592197418],
		[0.7373737096786499, 0.4542211592197418],
		[0.7373737096786499, 0.46373364329338074],
		[0.7239057421684265, 0.46373364329338074],
	],
	[
		[0.6936026811599731, 0.4946492314338684],
		[0.7390572428703308, 0.4946492314338684],
		[0.7390572428703308, 0.5053507685661316],
		[0.6936026811599731, 0.5053507685661316],
	],
	[
		[0.6936026811599731, 0.5255647897720337],
		[0.7390572428703308, 0.5255647897720337],
		[0.7390572428703308, 0.5350772738456726],
		[0.6936026811599731, 0.5350772738456726],
	],
	[
		[0.6936026811599731, 0.5386444926261902],
		[0.7390572428703308, 0.5386444926261902],
		[0.7390572428703308, 0.5493460297584534],
		[0.6936026811599731, 0.5493460297584534],
	],
	[
		[0.6936026811599731, 0.5529131889343262],
		[0.7390572428703308, 0.5529131889343262],
		[0.7390572428703308, 0.5636147260665894],
		[0.6936026811599731, 0.5636147260665894],
	],
	[
		[0.5353535413742065, 0.5671819448471069],
		[0.5656565427780151, 0.5683709979057312],
		[0.5656565427780151, 0.5790725350379944],
		[0.5353535413742065, 0.5790725350379944],
	],
	[
		[0.6936026811599731, 0.5671819448471069],
		[0.7390572428703308, 0.5671819448471069],
		[0.7390572428703308, 0.5778834819793701],
		[0.6936026811599731, 0.5778834819793701],
	],
	[
		[0.6936026811599731, 0.5814506411552429],
		[0.7390572428703308, 0.5814506411552429],
		[0.7390572428703308, 0.5921521782875061],
		[0.6936026811599731, 0.5921521782875061],
	],
	[
		[0.7222222089767456, 0.5957193970680237],
		[0.7356902360916138, 0.5957193970680237],
		[0.7356902360916138, 0.6064209342002869],
		[0.7222222089767456, 0.6064209342002869],
	],
	[
		[0.7222222089767456, 0.6099880933761597],
		[0.7356902360916138, 0.6099880933761597],
		[0.7356902360916138, 0.6206896305084229],
		[0.7222222089767456, 0.6206896305084229],
	],
	[
		[0.5370370149612427, 0.6254459023475647],
		[0.5656565427780151, 0.6254459023475647],
		[0.5656565427780151, 0.6361474394798279],
		[0.5370370149612427, 0.6361474394798279],
	],
	[
		[0.7222222089767456, 0.6242568492889404],
		[0.7356902360916138, 0.6242568492889404],
		[0.7356902360916138, 0.6349583864212036],
		[0.7222222089767456, 0.6349583864212036],
	],
	[
		[0.7239057421684265, 0.6397145986557007],
		[0.7356902360916138, 0.6397145986557007],
		[0.7356902360916138, 0.6492270827293396],
		[0.7239057421684265, 0.6492270827293396],
	],
	[
		[0.7239057421684265, 0.6539833545684814],
		[0.7356902360916138, 0.6539833545684814],
		[0.7356902360916138, 0.6634958386421204],
		[0.7239057421684265, 0.6634958386421204],
	],
	[
		[0.68855220079422, 0.696789562702179],
		[0.7356902360916138, 0.696789562702179],
		[0.7356902360916138, 0.7074910998344421],
		[0.68855220079422, 0.7086801528930664],
	],
	[
		[0.5370370149612427, 0.7229488492012024],
		[0.5656565427780151, 0.7229488492012024],
		[0.5656565427780151, 0.7336504459381104],
		[0.5370370149612427, 0.7336504459381104],
	],
	[
		[0.6936026811599731, 0.7229488492012024],
		[0.7373737096786499, 0.7229488492012024],
		[0.7373737096786499, 0.7360285520553589],
		[0.6936026811599731, 0.7360285520553589],
	],
	[
		[0.619528591632843, 0.7360285520553589],
		[0.7138047218322754, 0.7360285520553589],
		[0.7138047218322754, 0.7479191422462463],
		[0.619528591632843, 0.7479191422462463],
	],
	[
		[0.7239057421684265, 0.7360285520553589],
		[0.7373737096786499, 0.7360285520553589],
		[0.7373737096786499, 0.7479191422462463],
		[0.7239057421684265, 0.7479191422462463],
	],
	[
		[0.1111111119389534, 0.08561236411333084],
		[0.11616161465644836, 0.08561236411333084],
		[0.11447811126708984, 0.09750296920537949],
		[0.1111111119389534, 0.09750296920537949],
	],
	[
		[0.16161616146564484, 0.08561236411333084],
		[0.18686868250370026, 0.0868014246225357],
		[0.18686868250370026, 0.09869202971458435],
		[0.16161616146564484, 0.09869202971458435],
	],
	[
		[0.3080808222293854, 0.1034482792019844],
		[0.31144779920578003, 0.1034482792019844],
		[0.31144779920578003, 0.11296076327562332],
		[0.3080808222293854, 0.11296076327562332],
	],
	[
		[0.6632996797561646, 0.23186682164669037],
		[0.7154881954193115, 0.23186682164669037],
		[0.7154881954193115, 0.243757426738739],
		[0.6632996797561646, 0.243757426738739],
	],
	[
		[0.6717171669006348, 0.24613554775714874],
		[0.7154881954193115, 0.24613554775714874],
		[0.7154881954193115, 0.2580261528491974],
		[0.6717171669006348, 0.2580261528491974],
	],
	[
		[0.6734007000923157, 0.36623066663742065],
		[0.7154881954193115, 0.36623066663742065],
		[0.7154881954193115, 0.3781212866306305],
		[0.6734007000923157, 0.3781212866306305],
	],
	[
		[0.6683501601219177, 0.3947681188583374],
		[0.7138047218322754, 0.3947681188583374],
		[0.7138047218322754, 0.40665873885154724],
		[0.6683501601219177, 0.40665873885154724],
	],
];

const centerAlignedBoxes: BoundingBox[] = [
	[
		[0.7777777910232544, 0.28537455201148987],
		[0.8636363744735718, 0.28537455201148987],
		[0.8636363744735718, 0.298454225063324],
		[0.7777777910232544, 0.298454225063324],
	],
	[
		[0.7828282713890076, 0.29964327812194824],
		[0.8585858345031738, 0.29964327812194824],
		[0.8585858345031738, 0.3115338981151581],
		[0.7828282713890076, 0.3115338981151581],
	],
	[
		[0.7777777910232544, 0.31272295117378235],
		[0.8636363744735718, 0.31272295117378235],
		[0.8636363744735718, 0.3246135413646698],
		[0.7777777910232544, 0.3246135413646698],
	],
	[
		[0.7727272510528564, 0.3269916772842407],
		[0.868686854839325, 0.3269916772842407],
		[0.868686854839325, 0.34007135033607483],
		[0.7727272510528564, 0.34007135033607483],
	],
	[
		[0.7777777910232544, 0.34007135033607483],
		[0.8636363744735718, 0.3412604033946991],
		[0.8636363744735718, 0.3543400764465332],
		[0.7777777910232544, 0.35315102338790894],
	],
	[
		[0.7777777910232544, 0.35552912950515747],
		[0.8619528412818909, 0.35552912950515747],
		[0.8619528412818909, 0.3674197494983673],
		[0.7777777910232544, 0.3674197494983673],
	],
	[
		[0.7912458181381226, 0.3686088025569916],
		[0.8484848737716675, 0.3686088025569916],
		[0.8484848737716675, 0.3816884756088257],
		[0.7912458181381226, 0.3816884756088257],
	],
	[
		[0.7828282713890076, 0.38287752866744995],
		[0.8585858345031738, 0.38287752866744995],
		[0.8585858345031738, 0.39595720171928406],
		[0.7828282713890076, 0.39595720171928406],
	],
	[
		[0.7777777910232544, 0.3971462547779083],
		[0.8636363744735718, 0.3971462547779083],
		[0.8636363744735718, 0.41022592782974243],
		[0.7777777910232544, 0.40903687477111816],
	],
	[
		[0.7861952781677246, 0.4114149808883667],
		[0.8535353541374207, 0.4114149808883667],
		[0.8535353541374207, 0.4244946539402008],
		[0.7861952781677246, 0.4244946539402008],
	],
	[
		[0.7861952781677246, 0.4256837069988251],
		[0.8535353541374207, 0.4256837069988251],
		[0.8535353541374207, 0.4387633800506592],
		[0.7861952781677246, 0.4387633800506592],
	],
	[
		[0.7828282713890076, 0.43995243310928345],
		[0.8585858345031738, 0.43995243310928345],
		[0.8585858345031738, 0.45303210616111755],
		[0.7828282713890076, 0.45303210616111755],
	],
	[
		[0.7828282713890076, 0.4542211592197418],
		[0.8585858345031738, 0.4542211592197418],
		[0.8585858345031738, 0.4673008322715759],
		[0.7828282713890076, 0.4673008322715759],
	],
	[
		[0.7727272510528564, 0.4946492314338684],
		[0.8670033812522888, 0.4958382844924927],
		[0.8670033812522888, 0.5077288746833801],
		[0.7727272510528564, 0.5077288746833801],
	],
	[
		[0.7777777910232544, 0.5243757367134094],
		[0.8636363744735718, 0.5243757367134094],
		[0.8636363744735718, 0.5374554395675659],
		[0.7777777910232544, 0.5374554395675659],
	],
	[
		[0.7777777910232544, 0.5386444926261902],
		[0.8636363744735718, 0.5386444926261902],
		[0.8636363744735718, 0.5517241358757019],
		[0.7777777910232544, 0.5517241358757019],
	],
	[
		[0.7777777910232544, 0.5529131889343262],
		[0.8619528412818909, 0.5529131889343262],
		[0.8619528412818909, 0.5648037791252136],
		[0.7777777910232544, 0.5659928917884827],
	],
	[
		[0.7878788113594055, 0.5671819448471069],
		[0.8501683473587036, 0.5671819448471069],
		[0.8501683473587036, 0.5802615880966187],
		[0.7878788113594055, 0.5802615880966187],
	],
	[
		[0.7878788113594055, 0.5814506411552429],
		[0.8501683473587036, 0.5814506411552429],
		[0.8501683473587036, 0.5945303440093994],
		[0.7878788113594055, 0.5945303440093994],
	],
	[
		[0.7727272510528564, 0.6956004500389099],
		[0.8670033812522888, 0.6956004500389099],
		[0.8670033812522888, 0.7086801528930664],
		[0.7727272510528564, 0.7086801528930664],
	],
	[
		[0.7777777910232544, 0.7229488492012024],
		[0.8636363744735718, 0.7229488492012024],
		[0.8636363744735718, 0.7360285520553589],
		[0.7777777910232544, 0.7360285520553589],
	],
	[
		[0.7760942578315735, 0.23186682164669037],
		[0.8434343338012695, 0.23186682164669037],
		[0.8434343338012695, 0.24494649469852448],
		[0.7760942578315735, 0.24494649469852448],
	],
	[
		[0.7811447978019714, 0.24613554775714874],
		[0.8383838534355164, 0.24613554775714874],
		[0.8383838534355164, 0.25921520590782166],
		[0.7811447978019714, 0.2580261528491974],
	],
	[
		[0.7676767706871033, 0.36623066663742065],
		[0.8518518805503845, 0.36623066663742065],
		[0.8518518805503845, 0.37931033968925476],
		[0.7676767706871033, 0.37931033968925476],
	],
	[
		[0.7676767706871033, 0.3947681188583374],
		[0.8518518805503845, 0.3947681188583374],
		[0.8518518805503845, 0.4078477919101715],
		[0.7676767706871033, 0.4078477919101715],
	],
];

describe('geometry.test.ts', () => {
	test('getDistance', async () => {
		const d1 = getDistance([0, 0], [2, 2]);
		expect(d1).toBeCloseTo(Math.sqrt(2 * 2 + 2 * 2));

		const d2 = getDistance([2, 2], [4, 4]);
		expect(d2).toBeCloseTo(Math.sqrt(2 * 2 + 2 * 2));

		const d3 = getDistance([-2, 2], [0, 0]);
		expect(d3).toBeCloseTo(Math.sqrt(2 * 2 + 2 * 2));
	});

	test('getDistanceFromLine', async () => {
		const d1 = getDistanceFromLine([-2, 1], [4, 1], [3, -3]);
		expect(d1).toBe(4);

		const d2 = getDistanceFromLine([-2, 1], [4, 1], [-8, -2]);
		expect(d2).toBe(3);

		const d3 = getDistanceFromLine([-2, 1], [4, 1], [5, 3]);
		expect(d3).toBe(2);

		const d4 = getDistanceFromLine([-2, -2], [4, 4], [1, 2]);
		expect(d4).toBeCloseTo(0.7071);
	});

    test('getBoundingBoxAlignments (right)', async () => {
        const r1 = getBoundingBoxAlignments(rightAlignedBoxes);
        expect(r1).toBeTruthy();
        expect(r1[0]?.align).toBe("right")
        expect(r1[0]?.confidence).toBeGreaterThan(0.40);
    });

    test('getBoundingBoxAlignments (center)', async () => {
        const r1 = getBoundingBoxAlignments(centerAlignedBoxes);
        expect(r1).toBeTruthy();
        expect(r1[0]?.align).toBe("center")
        expect(r1[0]?.confidence).toBeGreaterThan(0.40);
    });


    test('getBoundingBoxAlignments (center)', async () => {
        const r1 = getBoundingBoxAlignments(centerAlignedBoxes);
        expect(r1).toBeTruthy();
        expect(r1[0]?.align).toBe("center")
        expect(r1[0]?.confidence).toBeGreaterThan(0.40);
    });


    test('getBoundingBoxAlignments (scaled)', async () => {
        const r1 = getBoundingBoxAlignments(rightAlignedBoxes);
        expect(r1).toBeTruthy();
        expect(r1[0]?.align).toBe("right")
        expect(r1[0]?.confidence).toBeGreaterThan(0.40);

        const biggerBoxes = rightAlignedBoxes.map(b => b.map(p => p.map(v => v*100)));
        const r2 = getBoundingBoxAlignments(biggerBoxes as BoundingBox[]);
        expect(r2).toBeTruthy();
        expect(r2[0]?.align).toBe("right")
        expect(r2[0]?.confidence).toBeGreaterThan(0.40);
        expect(r2[0]?.confidence).toBeCloseTo(r1[0]?.confidence as number);

        const smallerBoxes = rightAlignedBoxes.map(b => b.map(p => p.map(v => v/100)));
        const r3 = getBoundingBoxAlignments(biggerBoxes as BoundingBox[]);
        expect(r3).toBeTruthy();
        expect(r3[0]?.align).toBe("right")
        expect(r3[0]?.confidence).toBeGreaterThan(0.40);
        expect(r3[0]?.confidence).toBeCloseTo(r1[0]?.confidence as number);
    });
});
